<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Gin源码分析 - I&#39;m linuxfish</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="linuxfish" /><meta name="description" content="github仓库：https://github.com/gin-gonic/gin what Gin is a web framework written in Go (Golang). It features a martini-like API with much better performance, up to 40 times faster thanks to httprouter how 从" />






<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="http://localhost:1313/post/2019/10/27/source-code-of-gin-framework/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Gin源码分析" />
<meta property="og:description" content="github仓库：https://github.com/gin-gonic/gin what Gin is a web framework written in Go (Golang). It features a martini-like API with much better performance, up to 40 times faster thanks to httprouter how 从" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/2019/10/27/source-code-of-gin-framework/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-10-27T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2019-10-27T00:00:00&#43;00:00" />

<meta itemprop="name" content="Gin源码分析">
<meta itemprop="description" content="github仓库：https://github.com/gin-gonic/gin what Gin is a web framework written in Go (Golang). It features a martini-like API with much better performance, up to 40 times faster thanks to httprouter how 从"><meta itemprop="datePublished" content="2019-10-27T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-10-27T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="6315">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Gin源码分析"/>
<meta name="twitter:description" content="github仓库：https://github.com/gin-gonic/gin what Gin is a web framework written in Go (Golang). It features a martini-like API with much better performance, up to 40 times faster thanks to httprouter how 从"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">linuxfish</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">linuxfish</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Gin源码分析</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-10-27 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li>
          <ul>
            <li><a href="#what">what</a></li>
            <li><a href="#how">how</a></li>
            <li><a href="#其它">其它</a></li>
            <li><a href="#参考">参考</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>github仓库：<a href="https://github.com/gin-gonic/gin">https://github.com/gin-gonic/gin</a></p>
<h3 id="what">what</h3>
<p>Gin is a web framework written in Go (Golang). It features a martini-like API with much better performance, up to 40 times faster thanks to httprouter</p>
<h3 id="how">how</h3>
<p>从一个例子开始：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&#34;github.com/gin-gonic/gin&#34;</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/ping&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
			<span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="s">&#34;pong&#34;</span><span class="p">,</span>
		<span class="p">})</span>
	<span class="p">})</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span> <span class="c1">// listen and serve on 0.0.0.0:8080
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>先看看Default()是如何实现的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// Default returns an Engine instance with the Logger and Recovery middleware already attached.
</span><span class="c1"></span>  <span class="kd">func</span> <span class="nf">Default</span><span class="p">()</span> <span class="o">*</span><span class="nx">Engine</span> <span class="p">{</span>
      <span class="nf">debugPrintWARNINGDefault</span><span class="p">()</span>
      <span class="nx">engine</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
      <span class="c1">// 默认创建的engine自带了logger和recovery中间件
</span><span class="c1"></span>      <span class="c1">// 注意这里设置的是全局的中间件，每一个request都会被
</span><span class="c1"></span>      <span class="c1">// 在这里设置的中间件处理
</span><span class="c1"></span>      <span class="nx">engine</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nf">Logger</span><span class="p">(),</span> <span class="nf">Recovery</span><span class="p">())</span>
      <span class="k">return</span> <span class="nx">engine</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后我们来看看创建的engine长什么样</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// Engine is the framework&#39;s instance, it contains the muxer, middleware and configuration settings.
</span><span class="c1"></span>  <span class="c1">// Create an instance of Engine, by using New() or Default()
</span><span class="c1"></span>  <span class="kd">type</span> <span class="nx">Engine</span> <span class="kd">struct</span> <span class="p">{</span>
      <span class="nx">RouterGroup</span>
      <span class="c1">// 篇幅原因，以下字段省略
</span><span class="c1"></span>      <span class="c1">//...
</span><span class="c1"></span>   <span class="p">}</span> 
   
  <span class="c1">// Use attaches a global middleware to the router. ie. the middleware attached though Use() will be
</span><span class="c1"></span>  <span class="c1">// included in the handlers chain for every single request. Even 404, 405, static files...
</span><span class="c1"></span>  <span class="c1">// For example, this is the right place for a logger or error management middleware.
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">Use</span><span class="p">(</span><span class="nx">middleware</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span> <span class="p">{</span>
      <span class="c1">// 底层调用的是RouterGroup的方法
</span><span class="c1"></span>      <span class="nx">engine</span><span class="p">.</span><span class="nx">RouterGroup</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">middleware</span><span class="o">...</span><span class="p">)</span>
      <span class="c1">// 404时的handler
</span><span class="c1"></span>      <span class="nx">engine</span><span class="p">.</span><span class="nf">rebuild404Handlers</span><span class="p">()</span>
      <span class="c1">// 405时的handler
</span><span class="c1"></span>      <span class="nx">engine</span><span class="p">.</span><span class="nf">rebuild405Handlers</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">engine</span>
  <span class="p">}</span>  
  
 <span class="c1">// Use adds middleware to the group, see example code in GitHub.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">group</span> <span class="o">*</span><span class="nx">RouterGroup</span><span class="p">)</span> <span class="nf">Use</span><span class="p">(</span><span class="nx">middleware</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span> <span class="p">{</span>
    <span class="nx">group</span><span class="p">.</span><span class="nx">Handlers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">group</span><span class="p">.</span><span class="nx">Handlers</span><span class="p">,</span> <span class="nx">middleware</span><span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">group</span><span class="p">.</span><span class="nf">returnObj</span><span class="p">()</span>
<span class="p">}</span>
  
  <span class="kd">func</span> <span class="p">(</span><span class="nx">group</span> <span class="o">*</span><span class="nx">RouterGroup</span><span class="p">)</span> <span class="nf">combineHandlers</span><span class="p">(</span><span class="nx">handlers</span> <span class="nx">HandlersChain</span><span class="p">)</span> <span class="nx">HandlersChain</span> <span class="p">{</span>
    <span class="nx">finalSize</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">group</span><span class="p">.</span><span class="nx">Handlers</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="nx">handlers</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">finalSize</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">abortIndex</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;too many handlers&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">mergedHandlers</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">HandlersChain</span><span class="p">,</span> <span class="nx">finalSize</span><span class="p">)</span>
    <span class="nb">copy</span><span class="p">(</span><span class="nx">mergedHandlers</span><span class="p">,</span> <span class="nx">group</span><span class="p">.</span><span class="nx">Handlers</span><span class="p">)</span>
    <span class="nb">copy</span><span class="p">(</span><span class="nx">mergedHandlers</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">group</span><span class="p">.</span><span class="nx">Handlers</span><span class="p">):],</span> <span class="nx">handlers</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">mergedHandlers</span>
<span class="p">}</span>
      
</code></pre></td></tr></table>
</div>
</div><p>可以看到它内嵌了一个结构体<code>RouterGroup</code>，那么它是干嘛的呢？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// RouterGroup is used internally to configure router, a RouterGroup is associated with
</span><span class="c1">// a prefix and an array of handlers (middleware).
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">RouterGroup</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Handlers</span> <span class="nx">HandlersChain</span>
    <span class="nx">basePath</span> <span class="kt">string</span>
    <span class="nx">engine</span>   <span class="o">*</span><span class="nx">Engine</span>
    <span class="nx">root</span>     <span class="kt">bool</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>从注释上看，这就是负责路由映射的了。上面示例代码中的<code>r.GET</code>实际调用的是<code>RouterGroup</code>的方法(thanks to struct embedding)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// GET is a shortcut for router.Handle(&#34;GET&#34;, path, handle).
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">group</span> <span class="o">*</span><span class="nx">RouterGroup</span><span class="p">)</span> <span class="nf">GET</span><span class="p">(</span><span class="nx">relativePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">IRoutes</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">group</span><span class="p">.</span><span class="nf">handle</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">,</span> <span class="nx">relativePath</span><span class="p">,</span> <span class="nx">handlers</span><span class="p">)</span>
<span class="p">}</span>
  
  <span class="kd">func</span> <span class="p">(</span><span class="nx">group</span> <span class="o">*</span><span class="nx">RouterGroup</span><span class="p">)</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">httpMethod</span><span class="p">,</span> <span class="nx">relativePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="nx">HandlersChain</span><span class="p">)</span> <span class="nx">IRoutes</span> <span class="p">{</span>
    <span class="nx">absolutePath</span> <span class="o">:=</span> <span class="nx">group</span><span class="p">.</span><span class="nf">calculateAbsolutePath</span><span class="p">(</span><span class="nx">relativePath</span><span class="p">)</span>
    <span class="c1">// 如果在group上定义了共用的handler，比如logger和recovery此处会和传入的handlers一同返回
</span><span class="c1"></span>    <span class="nx">handlers</span> <span class="p">=</span> <span class="nx">group</span><span class="p">.</span><span class="nf">combineHandlers</span><span class="p">(</span><span class="nx">handlers</span><span class="p">)</span>
    <span class="c1">// 这里应该是建立请求路径和handler的映射关系
</span><span class="c1"></span>    <span class="c1">// 涉及到Redix tree算法，感兴趣的可以具体看看
</span><span class="c1"></span>    <span class="nx">group</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nf">addRoute</span><span class="p">(</span><span class="nx">httpMethod</span><span class="p">,</span> <span class="nx">absolutePath</span><span class="p">,</span> <span class="nx">handlers</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">group</span><span class="p">.</span><span class="nf">returnObj</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>再看一个复杂一点的例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// Creates a router without any middleware by default
</span><span class="c1"></span>	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>

	<span class="c1">// Global middleware
</span><span class="c1"></span>	<span class="c1">// Logger middleware will write the logs to gin.DefaultWriter even if you set with GIN_MODE=release.
</span><span class="c1"></span>	<span class="c1">// By default gin.DefaultWriter = os.Stdout
</span><span class="c1"></span>	<span class="nx">r</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">gin</span><span class="p">.</span><span class="nf">Logger</span><span class="p">())</span>

	<span class="c1">// Recovery middleware recovers from any panics and writes a 500 if there was one.
</span><span class="c1"></span>	<span class="nx">r</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">gin</span><span class="p">.</span><span class="nf">Recovery</span><span class="p">())</span>

	<span class="c1">// Per route middleware, you can add as many as you desire.
</span><span class="c1"></span>	<span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/benchmark&#34;</span><span class="p">,</span> <span class="nf">MyBenchLogger</span><span class="p">(),</span> <span class="nx">benchEndpoint</span><span class="p">)</span>

	<span class="c1">// Authorization group
</span><span class="c1"></span>	<span class="c1">// authorized := r.Group(&#34;/&#34;, AuthRequired())
</span><span class="c1"></span>	<span class="c1">// exactly the same as:
</span><span class="c1"></span>	<span class="nx">authorized</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Group</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">)</span>
	<span class="c1">// per group middleware! in this case we use the custom created
</span><span class="c1"></span>	<span class="c1">// AuthRequired() middleware just in the &#34;authorized&#34; group.
</span><span class="c1"></span>	<span class="nx">authorized</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nf">AuthRequired</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="nx">authorized</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/login&#34;</span><span class="p">,</span> <span class="nx">loginEndpoint</span><span class="p">)</span>
		<span class="nx">authorized</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/submit&#34;</span><span class="p">,</span> <span class="nx">submitEndpoint</span><span class="p">)</span>
		<span class="nx">authorized</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/read&#34;</span><span class="p">,</span> <span class="nx">readEndpoint</span><span class="p">)</span>

		<span class="c1">// nested group
</span><span class="c1"></span>		<span class="nx">testing</span> <span class="o">:=</span> <span class="nx">authorized</span><span class="p">.</span><span class="nf">Group</span><span class="p">(</span><span class="s">&#34;testing&#34;</span><span class="p">)</span>
		<span class="nx">testing</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/analytics&#34;</span><span class="p">,</span> <span class="nx">analyticsEndpoint</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// Listen and serve on 0.0.0.0:8080
</span><span class="c1"></span>	<span class="nx">r</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>从上面的例子中，我们知道还可以定义组的概念（对应url中有统一前缀的情况），而且还可以针对这个组来绑定统一的middleware，那么是怎么实现的呢？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Group creates a new router group. You should add all the routes that have common middlewares or the same path prefix.
</span><span class="c1">// For example, all the routes that use a common middleware for authorization could be grouped.
</span><span class="c1">// 返回的依然是一个RouterGroup，但，是一个新的RouterGroup对象
</span><span class="c1">// 且，Handlers和basePath都基于base group做了相应的更新
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">group</span> <span class="o">*</span><span class="nx">RouterGroup</span><span class="p">)</span> <span class="nf">Group</span><span class="p">(</span><span class="nx">relativePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">HandlerFunc</span><span class="p">)</span> <span class="o">*</span><span class="nx">RouterGroup</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">RouterGroup</span><span class="p">{</span>
        <span class="nx">Handlers</span><span class="p">:</span> <span class="nx">group</span><span class="p">.</span><span class="nf">combineHandlers</span><span class="p">(</span><span class="nx">handlers</span><span class="p">),</span>
        <span class="nx">basePath</span><span class="p">:</span> <span class="nx">group</span><span class="p">.</span><span class="nf">calculateAbsolutePath</span><span class="p">(</span><span class="nx">relativePath</span><span class="p">),</span>
        <span class="nx">engine</span><span class="p">:</span>   <span class="nx">group</span><span class="p">.</span><span class="nx">engine</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以上就做好了url与处理逻辑的绑定，下面再看一下是如何Run起来的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// Run attaches the router to a http.Server and starts listening and serving HTTP requests.
</span><span class="c1"></span>  <span class="c1">// It is a shortcut for http.ListenAndServe(addr, router)
</span><span class="c1"></span>  <span class="c1">// Note: this method will block the calling goroutine indefinitely unless an error happens.
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">addr</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nf">debugPrintError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">}()</span>

      <span class="nx">address</span> <span class="o">:=</span> <span class="nf">resolveAddress</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span>
      <span class="nf">debugPrint</span><span class="p">(</span><span class="s">&#34;Listening and serving HTTP on %s\n&#34;</span><span class="p">,</span> <span class="nx">address</span><span class="p">)</span>
      <span class="nx">err</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">engine</span><span class="p">)</span>
      <span class="k">return</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>从上面看，就是直接调用了http包的ListenAndServe，嗯，那engine一定是实现了http要求的接口了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// ServeHTTP conforms to the http.Handler interface.
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 从池子中取出一个ctx
</span><span class="c1"></span>      <span class="nx">c</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nf">Get</span><span class="p">().(</span><span class="o">*</span><span class="nx">Context</span><span class="p">)</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">writermem</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
      <span class="c1">// 请求放在了ctx的Request字段上
</span><span class="c1"></span>      <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span> <span class="p">=</span> <span class="nx">req</span>
      <span class="nx">c</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>

      <span class="nx">engine</span><span class="p">.</span><span class="nf">handleHTTPRequest</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>

      <span class="nx">engine</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，只要实现这一个方法就能无缝对接http包的Server功能，完全不用care服务端的listen、accept、connect这些细节，只关注具体的处理逻辑就行了，这太值了！</p>
<p>从<code>ServeHTTP</code>的代码看出，这里的逻辑也很简略，就是从对象池取出一个Context，然后把它扔给<code>handleHTTPRequest</code>而已。关于Context的实现我们待会再细说，现在先重点分析下<code>handleHTTPRequest</code>相关的逻辑，上面设置了那么多middleware和handler，那么具体是怎么被执行的呢？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">handleHTTPRequest</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 解析出method、path
</span><span class="c1"></span>      <span class="nx">httpMethod</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span>
      <span class="nx">rPath</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span>
      <span class="nx">unescape</span> <span class="o">:=</span> <span class="kc">false</span>
      <span class="k">if</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">UseRawPath</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawPath</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
          <span class="nx">rPath</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawPath</span>
          <span class="nx">unescape</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">UnescapePathValues</span>
      <span class="p">}</span>
      <span class="nx">rPath</span> <span class="p">=</span> <span class="nf">cleanPath</span><span class="p">(</span><span class="nx">rPath</span><span class="p">)</span>

      <span class="c1">// Find root of the tree for the given HTTP method
</span><span class="c1"></span>      <span class="c1">// 然后开始在路由树中匹配
</span><span class="c1"></span>      <span class="nx">t</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">trees</span>
      <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">tl</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">tl</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
          <span class="k">if</span> <span class="nx">t</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">method</span> <span class="o">!=</span> <span class="nx">httpMethod</span> <span class="p">{</span>
              <span class="k">continue</span>
          <span class="p">}</span>
          <span class="nx">root</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">root</span>
          <span class="c1">// Find route in tree
</span><span class="c1"></span>          <span class="c1">// 如果能匹配上，则会返回这个路径对应的handlers
</span><span class="c1"></span>          <span class="nx">handlers</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">tsr</span> <span class="o">:=</span> <span class="nx">root</span><span class="p">.</span><span class="nf">getValue</span><span class="p">(</span><span class="nx">rPath</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Params</span><span class="p">,</span> <span class="nx">unescape</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
              <span class="c1">// 注意全都赋给了Context
</span><span class="c1"></span>              <span class="c1">// 艰巨的任务交给了Context同志
</span><span class="c1"></span>              <span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span> <span class="p">=</span> <span class="nx">handlers</span>
              <span class="nx">c</span><span class="p">.</span><span class="nx">Params</span> <span class="p">=</span> <span class="nx">params</span>
              <span class="c1">// 关键点，只是调用了一下Next()！！
</span><span class="c1"></span>              <span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
              <span class="nx">c</span><span class="p">.</span><span class="nx">writermem</span><span class="p">.</span><span class="nf">WriteHeaderNow</span><span class="p">()</span>
              <span class="k">return</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="nx">httpMethod</span> <span class="o">!=</span> <span class="s">&#34;CONNECT&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">rPath</span> <span class="o">!=</span> <span class="s">&#34;/&#34;</span> <span class="p">{</span>
              <span class="k">if</span> <span class="nx">tsr</span> <span class="o">&amp;&amp;</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">RedirectTrailingSlash</span> <span class="p">{</span>
                  <span class="nf">redirectTrailingSlash</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
                  <span class="k">return</span>
              <span class="p">}</span>
              <span class="k">if</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">RedirectFixedPath</span> <span class="o">&amp;&amp;</span> <span class="nf">redirectFixedPath</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">RedirectFixedPath</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span>
              <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">break</span>
      <span class="p">}</span>
      
      <span class="c1">// 路径匹配但方法不匹配的情况
</span><span class="c1"></span>      <span class="k">if</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">HandleMethodNotAllowed</span> <span class="p">{</span>
          <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">tree</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">trees</span> <span class="p">{</span>
              <span class="k">if</span> <span class="nx">tree</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="nx">httpMethod</span> <span class="p">{</span>
                  <span class="k">continue</span>
              <span class="p">}</span>
              <span class="k">if</span> <span class="nx">handlers</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">tree</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nf">getValue</span><span class="p">(</span><span class="nx">rPath</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">unescape</span><span class="p">);</span> <span class="nx">handlers</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                  <span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">allNoMethod</span>
                  <span class="nf">serveError</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusMethodNotAllowed</span><span class="p">,</span> <span class="nx">default405Body</span><span class="p">)</span>
                  <span class="k">return</span>
              <span class="p">}</span>
          <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// 没找到路径的情况
</span><span class="c1"></span>      <span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span> <span class="p">=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">allNoRoute</span>
      <span class="nf">serveError</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusNotFound</span><span class="p">,</span> <span class="nx">default404Body</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>那么问题来了，<code>c.Next()</code>是何方神圣？尽管说要等下再分析Context，但，已经等不及了..</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// Next should be used only inside middleware.
</span><span class="c1"></span>  <span class="c1">// It executes the pending handlers in the chain inside the calling handler.
</span><span class="c1"></span>  <span class="c1">// See example in GitHub.
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span>
      <span class="c1">// 注意c.index初始化时是被置为-1的，因此
</span><span class="c1"></span>      <span class="c1">// 逻辑也就是把c.handlers从头遍历、执行一遍
</span><span class="c1"></span>      <span class="k">for</span> <span class="nx">c</span><span class="p">.</span><span class="nx">index</span> <span class="p">&lt;</span> <span class="nb">int8</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">c</span><span class="p">.</span><span class="nx">index</span><span class="p">](</span><span class="nx">c</span><span class="p">)</span>
          <span class="nx">c</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span>
      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>擦，竟然丧心病狂的只有这么短？而且逻辑也很清楚，就是把handlers依次执行一遍，这能实现普通的handler的功能我信，但能实现middleware的功能我是不信的，顺便科普下大名鼎鼎的middleware的基本功能：</p>
<blockquote>
<p>I use the term middleware, but each language/framework calls the concept differently. NodeJS and Rails calls it middleware. In the Java enterprise world (i.e. Java Servlet), it’s called filters. C# calls it delegate handlers. <strong>Essentially, the middleware performs some specific function on the HTTP request or response at a specific stage in the HTTP pipeline before or after the user defined controller.</strong> Middleware is a design pattern to eloquently add cross cutting concerns like logging, handling authentication, or gzip compression without having many code contact points. refer: <a href="https://www.moesif.com/blog/engineering/middleware/What-Is-HTTP-Middleware/#">What is HTTP middleware?</a></p>
</blockquote>
<p>一个http中间件基本上会分别在用户自定义业务逻辑之前和之后执行，所以一个含有中间件的业务的执行逻辑应该是这样：</p>
<ul>
<li>中间件的pre_request逻辑</li>
<li>用户自定义业务逻辑</li>
<li>中间件的post_request逻辑</li>
</ul>
<p>可以看到中间件的逻辑是被用户自定义逻辑给割裂开了，分两段执行，用一张图来表示可能更清楚：</p>
<p><img src="https://i.imgur.com/96NE89V.png" alt=""></p>
<p>直接找一个内置middleware的实现来分析下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// LoggerWithConfig instance a Logger middleware with config.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">LoggerWithConfig</span><span class="p">(</span><span class="nx">conf</span> <span class="nx">LoggerConfig</span><span class="p">)</span> <span class="nx">HandlerFunc</span> <span class="p">{</span>
        
        <span class="c1">// ...
</span><span class="c1"></span>        <span class="c1">// 前面省略一堆配置logger的逻辑
</span><span class="c1"></span>        <span class="c1">// ...
</span><span class="c1"></span>    
        <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Start timer
</span><span class="c1"></span>        <span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
        <span class="nx">path</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span>
        <span class="nx">raw</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawQuery</span>

        <span class="c1">// Process request
</span><span class="c1"></span>        <span class="c1">// 这里也调了c.Next()！！
</span><span class="c1"></span>        <span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>

        <span class="c1">// Log only when path is not being skipped
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">skip</span><span class="p">[</span><span class="nx">path</span><span class="p">];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">param</span> <span class="o">:=</span> <span class="nx">LogFormatterParams</span><span class="p">{</span>
                <span class="nx">Request</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span>
                <span class="nx">isTerm</span><span class="p">:</span>  <span class="nx">isTerm</span><span class="p">,</span>
                <span class="nx">Keys</span><span class="p">:</span>    <span class="nx">c</span><span class="p">.</span><span class="nx">Keys</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1">// Stop timer
</span><span class="c1"></span>            <span class="nx">param</span><span class="p">.</span><span class="nx">TimeStamp</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
            <span class="nx">param</span><span class="p">.</span><span class="nx">Latency</span> <span class="p">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">TimeStamp</span><span class="p">.</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span>

            <span class="nx">param</span><span class="p">.</span><span class="nx">ClientIP</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ClientIP</span><span class="p">()</span>
            <span class="nx">param</span><span class="p">.</span><span class="nx">Method</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span>
            <span class="nx">param</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">.</span><span class="nf">Status</span><span class="p">()</span>
            <span class="nx">param</span><span class="p">.</span><span class="nx">ErrorMessage</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Errors</span><span class="p">.</span><span class="nf">ByType</span><span class="p">(</span><span class="nx">ErrorTypePrivate</span><span class="p">).</span><span class="nf">String</span><span class="p">()</span>

            <span class="nx">param</span><span class="p">.</span><span class="nx">BodySize</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">.</span><span class="nf">Size</span><span class="p">()</span>

            <span class="k">if</span> <span class="nx">raw</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
                <span class="nx">path</span> <span class="p">=</span> <span class="nx">path</span> <span class="o">+</span> <span class="s">&#34;?&#34;</span> <span class="o">+</span> <span class="nx">raw</span>
            <span class="p">}</span>

            <span class="nx">param</span><span class="p">.</span><span class="nx">Path</span> <span class="p">=</span> <span class="nx">path</span>

            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprint</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nf">formatter</span><span class="p">(</span><span class="nx">param</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，玄机在于middleware里也调了一次<code>c.Next()</code>，那为什么这样就能实现middleware的功能呢？我们来分析一下：</p>
<p>假设除了用户业务逻辑外，只有这一个middleware，那么，执行流程会是这样：</p>
<ul>
<li><code>handleHTTPRequest</code> 中的<code>c.Next()</code>触发了Logger middleware的执行</li>
<li>Logger middleware先执行了直到<code>c.Next()</code>之前的逻辑</li>
<li>又进入<code>c.Next()</code>函数，此时index++，开始下一个handler函数，即用户自定义业务逻辑</li>
<li>执行用户自定义业务逻辑完成后返回</li>
<li>此时，第二步中的<code>c.Next()</code>调用执行完成</li>
<li>开始执行<code>c.Next()</code>后边的逻辑</li>
<li>完成</li>
</ul>
<p>可以看到，里面涉及到了对<code>c.Next()</code>的递归调用，而middleware功能的实现正是借助对函数的递归调用和层层返回来实现的。</p>
<p>middleware的实现逻辑理清楚后我们来正式看下Context的实现，这个号称是Gin里最重要的结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// Context is the most important part of gin. It allows us to pass variables between middleware,
</span><span class="c1"></span>  <span class="c1">// manage the flow, validate the JSON of a request and render a JSON response for example.
</span><span class="c1"></span>  <span class="kd">type</span> <span class="nx">Context</span> <span class="kd">struct</span> <span class="p">{</span>
      <span class="nx">writermem</span> <span class="nx">responseWriter</span>
      <span class="nx">Request</span>   <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span>
      <span class="nx">Writer</span>    <span class="nx">ResponseWriter</span>

      <span class="nx">Params</span>   <span class="nx">Params</span>
      <span class="nx">handlers</span> <span class="nx">HandlersChain</span>
      <span class="nx">index</span>    <span class="kt">int8</span>

      <span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span>

      <span class="c1">// Keys is a key/value pair exclusively for the context of each request.
</span><span class="c1"></span>      <span class="nx">Keys</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>

      <span class="c1">// Errors is a list of errors attached to all the handlers/middlewares who used this context.
</span><span class="c1"></span>      <span class="nx">Errors</span> <span class="nx">errorMsgs</span>

      <span class="c1">// Accepted defines a list of manually accepted formats for content negotiation.
</span><span class="c1"></span>      <span class="nx">Accepted</span> <span class="p">[]</span><span class="kt">string</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>通过注释我们看到，它的作用有：流程控制（即实现middleware）、校验和绑定request和渲染response。流程控制我们前面已经分析过了，下面重点分析下后两个是怎么做的</p>
<p>先分析request的处理，先来个例子看下怎么用的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Binding from JSON
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Login</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">User</span>     <span class="kt">string</span> <span class="s">`form:&#34;user&#34; json:&#34;user&#34; xml:&#34;user&#34;  binding:&#34;required&#34;`</span>
	<span class="nx">Password</span> <span class="kt">string</span> <span class="s">`form:&#34;password&#34; json:&#34;password&#34; xml:&#34;password&#34; binding:&#34;required&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">router</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>

	<span class="c1">// Example for binding JSON ({&#34;user&#34;: &#34;manu&#34;, &#34;password&#34;: &#34;123&#34;})
</span><span class="c1"></span>	<span class="nx">router</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/loginJSON&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">json</span> <span class="nx">Login</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ShouldBindJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">json</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&#34;error&#34;</span><span class="p">:</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()})</span>
			<span class="k">return</span>
		<span class="p">}</span>
		
		<span class="k">if</span> <span class="nx">json</span><span class="p">.</span><span class="nx">User</span> <span class="o">!=</span> <span class="s">&#34;manu&#34;</span> <span class="o">||</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Password</span> <span class="o">!=</span> <span class="s">&#34;123&#34;</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&#34;status&#34;</span><span class="p">:</span> <span class="s">&#34;unauthorized&#34;</span><span class="p">})</span>
			<span class="k">return</span>
		<span class="p">}</span> 
		
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&#34;status&#34;</span><span class="p">:</span> <span class="s">&#34;you are logged in&#34;</span><span class="p">})</span>
	<span class="p">})</span>
	
    <span class="c1">// Listen and serve on 0.0.0.0:8080
</span><span class="c1"></span>	<span class="nx">router</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="s">&#34;:8080&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到它通过一个<code>c.ShouldBindJSON</code>可以把request data（json格式的）绑定到自定义的struct上，它还支持很多其它方法来绑定其它格式的输入，比如：</p>
<ul>
<li>ShouldBindXML</li>
<li>ShouldBindQuery</li>
<li>ShouldBindYAML</li>
<li>ShouldBindHeader</li>
</ul>
<p>我们来具体分析下它的实现原理，拿一个<code>BindJSON</code>来看，其它的都类似</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// BindJSON is a shortcut for c.MustBindWith(obj, binding.JSON).
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="nf">BindJSON</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">MustBindWith</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">JSON</span><span class="p">)</span>
  <span class="p">}</span>
  
  <span class="c1">// MustBindWith binds the passed struct pointer using the specified binding engine.
</span><span class="c1"></span>  <span class="c1">// It will abort the request with HTTP 400 if any error occurs.
</span><span class="c1"></span>  <span class="c1">// See the binding package.
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="nf">MustBindWith</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">b</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">Binding</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ShouldBindWith</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="nx">c</span><span class="p">.</span><span class="nf">AbortWithError</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span> <span class="nx">err</span><span class="p">).</span><span class="nf">SetType</span><span class="p">(</span><span class="nx">ErrorTypeBind</span><span class="p">)</span> <span class="c1">// nolint: errcheck
</span><span class="c1"></span>          <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">nil</span>
  <span class="p">}</span>
  
  <span class="c1">// ShouldBindWith binds the passed struct pointer using the specified binding engine.
</span><span class="c1"></span>  <span class="c1">// See the binding package.
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="nf">ShouldBindWith</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">b</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">Binding</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
  <span class="p">}</span>
  
  <span class="c1">// Binding describes the interface which needs to be implemented for binding the
</span><span class="c1"></span>  <span class="c1">// data present in the request such as JSON request body, query parameters or
</span><span class="c1"></span>  <span class="c1">// the form POST.
</span><span class="c1"></span>  <span class="kd">type</span> <span class="nx">Binding</span> <span class="kd">interface</span> <span class="p">{</span>
      <span class="nf">Name</span><span class="p">()</span> <span class="kt">string</span>
      <span class="nf">Bind</span><span class="p">(</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span>
  <span class="p">}</span>
  
  <span class="c1">// These implement the Binding interface and can be used to bind the data
</span><span class="c1"></span>  <span class="c1">// present in the request to struct instances.
</span><span class="c1"></span>  <span class="kd">var</span> <span class="p">(</span>
      <span class="nx">JSON</span>          <span class="p">=</span> <span class="nx">jsonBinding</span><span class="p">{}</span>
      <span class="nx">XML</span>           <span class="p">=</span> <span class="nx">xmlBinding</span><span class="p">{}</span>
      <span class="nx">Form</span>          <span class="p">=</span> <span class="nx">formBinding</span><span class="p">{}</span>
      <span class="nx">Query</span>         <span class="p">=</span> <span class="nx">queryBinding</span><span class="p">{}</span>
      <span class="nx">FormPost</span>      <span class="p">=</span> <span class="nx">formPostBinding</span><span class="p">{}</span>
      <span class="nx">FormMultipart</span> <span class="p">=</span> <span class="nx">formMultipartBinding</span><span class="p">{}</span>
      <span class="nx">ProtoBuf</span>      <span class="p">=</span> <span class="nx">protobufBinding</span><span class="p">{}</span>
      <span class="nx">MsgPack</span>       <span class="p">=</span> <span class="nx">msgpackBinding</span><span class="p">{}</span>
      <span class="nx">YAML</span>          <span class="p">=</span> <span class="nx">yamlBinding</span><span class="p">{}</span>
      <span class="nx">Uri</span>           <span class="p">=</span> <span class="nx">uriBinding</span><span class="p">{}</span>
  <span class="p">)</span>
  
<span class="kd">type</span> <span class="nx">jsonBinding</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">jsonBinding</span><span class="p">)</span> <span class="nf">Name</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&#34;json&#34;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">jsonBinding</span><span class="p">)</span> <span class="nf">Bind</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">req</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Body</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid request&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nf">decodeJSON</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">decodeJSON</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">decoder</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">EnableDecoderUseNumber</span> <span class="p">{</span>
        <span class="nx">decoder</span><span class="p">.</span><span class="nf">UseNumber</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">decoder</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nf">validate</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，<code>BindXXX</code> &ndash;&gt; <code>MustBindWith</code> &ndash;&gt; <code>ShouldBindWith</code> &ndash;&gt; <code>b.Bind</code>，所有支持的格式都是一样的模式，后续如果想增加一个新的格式，只需要按照<code>Binding</code>
这个接口来实现一下那两个方法就可以用了。</p>
<p>对参数的校验用到了<a href="https://github.com/go-playground/validator">validator</a>这个包，下面具体分析一下</p>
<p>以 bindJSON 为例，最终会调用到<code>decodeJSON</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">decodeJSON</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">decoder</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">EnableDecoderUseNumber</span> <span class="p">{</span>
		<span class="nx">decoder</span><span class="p">.</span><span class="nf">UseNumber</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">EnableDecoderDisallowUnknownFields</span> <span class="p">{</span>
		<span class="nx">decoder</span><span class="p">.</span><span class="nf">DisallowUnknownFields</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">decoder</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nf">validate</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">Validator</span> <span class="nx">StructValidator</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">defaultValidator</span><span class="p">{}</span>

<span class="c1">// validate的定义在此
</span><span class="c1">// 位于binding/binding.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">validate</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">Validator</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">Validator</span><span class="p">.</span><span class="nf">ValidateStruct</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 位于binding/default_validator.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="o">*</span><span class="nx">defaultValidator</span><span class="p">)</span> <span class="nf">ValidateStruct</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">value</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
	<span class="nx">valueType</span> <span class="o">:=</span> <span class="nx">value</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">valueType</span> <span class="o">==</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Ptr</span> <span class="p">{</span>
		<span class="nx">valueType</span> <span class="p">=</span> <span class="nx">value</span><span class="p">.</span><span class="nf">Elem</span><span class="p">().</span><span class="nf">Kind</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">valueType</span> <span class="o">==</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Struct</span> <span class="p">{</span>
	   <span class="c1">// 懒加载
</span><span class="c1"></span>		<span class="nx">v</span><span class="p">.</span><span class="nf">lazyinit</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">validate</span><span class="p">.</span><span class="nf">Struct</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">err</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="o">*</span><span class="nx">defaultValidator</span><span class="p">)</span> <span class="nf">lazyinit</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">v</span><span class="p">.</span><span class="nx">once</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">v</span><span class="p">.</span><span class="nx">validate</span> <span class="p">=</span> <span class="nx">validator</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
		<span class="nx">v</span><span class="p">.</span><span class="nx">validate</span><span class="p">.</span><span class="nf">SetTagName</span><span class="p">(</span><span class="s">&#34;binding&#34;</span><span class="p">)</span>
	<span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>下面分析下处理完的结果是如何返回http response的（包括http status、header、resp body等）：</p>
<p>我们知道<code>net/http</code>包中经典函数签名<code>ServeHTTP(w http.ResponseWriter, req *http.Request)</code>，其中这个w就是用于返回response的，向它写入数据即可，那么Gin中是怎么跟它联系上的呢？</p>
<p>仍然需要再看一遍engine的ServeHTTP这个方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// ServeHTTP conforms to the http.Handler interface.
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">engine</span> <span class="o">*</span><span class="nx">Engine</span><span class="p">)</span> <span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 从池子中取出一个ctx
</span><span class="c1"></span>      <span class="nx">c</span> <span class="o">:=</span> <span class="nx">engine</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nf">Get</span><span class="p">().(</span><span class="o">*</span><span class="nx">Context</span><span class="p">)</span>
      <span class="c1">// 此处把w绑定到ctx上了
</span><span class="c1"></span>      <span class="nx">c</span><span class="p">.</span><span class="nx">writermem</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
      <span class="c1">// 请求放在了ctx的Request字段上
</span><span class="c1"></span>      <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span> <span class="p">=</span> <span class="nx">req</span>
      <span class="c1">// 设置Writer等, 重置handlers，后面handleHTTPRequest会根据请求路径重新计算
</span><span class="c1"></span>      <span class="nx">c</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>

      <span class="nx">engine</span><span class="p">.</span><span class="nf">handleHTTPRequest</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>

      <span class="nx">engine</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// 来自：response_writer.go
</span><span class="c1"></span>  <span class="kd">type</span> <span class="nx">responseWriter</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span>
    <span class="nx">size</span>   <span class="kt">int</span>
    <span class="nx">status</span> <span class="kt">int</span>
<span class="p">}</span>
  <span class="c1">// 来自：response_writer.go
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">responseWriter</span><span class="p">)</span> <span class="nf">reset</span><span class="p">(</span><span class="nx">writer</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// w是在这里被绑定到Gin内部的一个结构体responseWriter上的
</span><span class="c1"></span>    <span class="nx">w</span><span class="p">.</span><span class="nx">ResponseWriter</span> <span class="p">=</span> <span class="nx">writer</span>
    <span class="nx">w</span><span class="p">.</span><span class="nx">size</span> <span class="p">=</span> <span class="nx">noWritten</span>
    <span class="nx">w</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">defaultStatus</span>
<span class="p">}</span>
   <span class="c1">// 来自：context.go
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="nf">reset</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">writermem</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">Params</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">handlers</span> <span class="p">=</span> <span class="kc">nil</span>
      <span class="c1">// 初始是-1，那就可以理解Next()中的index++了
</span><span class="c1"></span>      <span class="nx">c</span><span class="p">.</span><span class="nx">index</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">Keys</span> <span class="p">=</span> <span class="kc">nil</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">Errors</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Errors</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">Accepted</span> <span class="p">=</span> <span class="kc">nil</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>思考一个问题：</p>
<blockquote>
<p>为何有<code>writermem</code>和<code>Writer</code>两个功能类似的字段？它们两个从功能上看都是用于返回response的</p>
</blockquote>
<p>使用上看，<code>http.ResponseWriter</code>先被赋给了<code>writermem</code>里的一个字段，然后<code>writermem</code>又被赋给了<code>Writer</code>。那么为啥要这么绕呢？我的理解：<code>Writer</code>是gin自己定义的接口，它扩展了Golang的<code>http.ResponseWriter</code>接口，因此直接把<code>http.ResponseWriter</code>赋给<code>Writer</code>肯定不行，只能曲线救国，这样就可以既能享用<code>http.ResponseWriter</code>的好处又能有自己的扩展功能。（其实，感觉只使用<code>writermem</code>这一个字段也能满足，暂时没想明白增加一个自定义接口的作用）</p>
<p>返回的response的格式也可以是多种多样的，比如json、xml、yaml等，是如何支持多种格式的呢？以json为例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// JSON serializes the given struct as JSON into the response body.
</span><span class="c1"></span>  <span class="c1">// It also sets the Content-Type as &#34;application/json&#34;.
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="nf">JSON</span><span class="p">(</span><span class="nx">code</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
      <span class="nx">c</span><span class="p">.</span><span class="nf">Render</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">render</span><span class="p">.</span><span class="nx">JSON</span><span class="p">{</span><span class="nx">Data</span><span class="p">:</span> <span class="nx">obj</span><span class="p">})</span>
  <span class="p">}</span>
  
  <span class="c1">// Render writes the response headers and calls render.Render to render data.
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="nf">Render</span><span class="p">(</span><span class="nx">code</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">r</span> <span class="nx">render</span><span class="p">.</span><span class="nx">Render</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span><span class="p">.</span><span class="nf">Status</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>

      <span class="k">if</span> <span class="p">!</span><span class="nf">bodyAllowedForStatus</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">r</span><span class="p">.</span><span class="nf">WriteContentType</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span>
          <span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">.</span><span class="nf">WriteHeaderNow</span><span class="p">()</span>
          <span class="k">return</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Render</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="c1">// Status sets the HTTP response code.
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Context</span><span class="p">)</span> <span class="nf">Status</span><span class="p">(</span><span class="nx">code</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">writermem</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
  <span class="p">}</span>
  
<span class="c1">// Render interface is to be implemented by JSON, XML, HTML, YAML and so on.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Render</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">// Render writes data with custom ContentType.
</span><span class="c1"></span>    <span class="nf">Render</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">)</span> <span class="kt">error</span>
    <span class="c1">// WriteContentType writes custom ContentType.
</span><span class="c1"></span>    <span class="nf">WriteContentType</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">)</span>
<span class="p">}</span>
  
  <span class="c1">// JSON contains the given interface object.
</span><span class="c1"></span>  <span class="c1">// 来源：render/json.go
</span><span class="c1"></span>  <span class="c1">// 这就是上面那个render.JSON
</span><span class="c1"></span>  <span class="kd">type</span> <span class="nx">JSON</span> <span class="kd">struct</span> <span class="p">{</span>
      <span class="nx">Data</span> <span class="kd">interface</span><span class="p">{}</span>
  <span class="p">}</span>
  
  <span class="c1">// Render (JSON) writes data with custom ContentType.
</span><span class="c1"></span>  <span class="c1">// 来源：render/json.go
</span><span class="c1"></span>  <span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="nx">JSON</span><span class="p">)</span> <span class="nf">Render</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">WriteJSON</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">return</span>
  <span class="p">}</span>
  
  <span class="c1">// WriteJSON marshals the given interface object and writes it with custom ContentType.
</span><span class="c1"></span>  <span class="c1">// 来源：render/json.go
</span><span class="c1"></span>  <span class="kd">func</span> <span class="nf">WriteJSON</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="nf">writeContentType</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">jsonContentType</span><span class="p">)</span>
      <span class="nx">jsonBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">jsonBytes</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>跟绑定request是一样的套路，<code>c.XXX</code> &ndash;&gt; <code>c.Render</code> &ndash;&gt; <code>r.Render(c.Writer)</code>，后续如果想加新的格式，遵循Render接口实现那两个方法即可</p>
<h3 id="其它">其它</h3>
<h4 id="对json的优化">对json的优化</h4>
<p>内置了两种json实现，一个是标准库的<code>encoding/json</code>，另一个是<code>github.com/json-iterator/go</code>，在编译的时候通过指定tag可以选择使用哪种实现。我们看看这是怎么做到的</p>
<p>定义好内部包<code>internal/json</code>，这个包下有两个文件，json.go和jsoniter.go，分别代表标准库和jsoniter的实现，以jsoniter为例来看一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// +build jsoniter
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">json</span>

<span class="kn">import</span> <span class="s">&#34;github.com/json-iterator/go&#34;</span>

<span class="kd">var</span> <span class="p">(</span>
    <span class="nx">json</span> <span class="p">=</span> <span class="nx">jsoniter</span><span class="p">.</span><span class="nx">ConfigCompatibleWithStandardLibrary</span>
    <span class="c1">// Marshal is exported by gin/json package.
</span><span class="c1"></span>    <span class="nx">Marshal</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span>
    <span class="c1">// Unmarshal is exported by gin/json package.
</span><span class="c1"></span>    <span class="nx">Unmarshal</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span>
    <span class="c1">// MarshalIndent is exported by gin/json package.
</span><span class="c1"></span>    <span class="nx">MarshalIndent</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">MarshalIndent</span>
    <span class="c1">// NewDecoder is exported by gin/json package.
</span><span class="c1"></span>    <span class="nx">NewDecoder</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">NewDecoder</span>
    <span class="c1">// NewEncoder is exported by gin/json package.
</span><span class="c1"></span>    <span class="nx">NewEncoder</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">NewEncoder</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>只是import相应的包，然后再把一些公开方法export出来，注意到最开头的一行：<code>// +build jsoniter</code>，它的意思是，当指定编译tag为<code>jsoniter</code>时，使用当前文件来编译</p>
<p>对比另一个文件， 它的开头写着：<code>// +build !jsoniter</code>，表示当tag不是<code>jsoniter</code>时用这个文件编译</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// +build !jsoniter
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">json</span>

<span class="kn">import</span> <span class="s">&#34;encoding/json&#34;</span>

<span class="kd">var</span> <span class="p">(</span>
    <span class="c1">// Marshal is exported by gin/json package.
</span><span class="c1"></span>    <span class="nx">Marshal</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span>
    <span class="c1">// Unmarshal is exported by gin/json package.
</span><span class="c1"></span>    <span class="nx">Unmarshal</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span>
    <span class="c1">// MarshalIndent is exported by gin/json package.
</span><span class="c1"></span>    <span class="nx">MarshalIndent</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">MarshalIndent</span>
    <span class="c1">// NewDecoder is exported by gin/json package.
</span><span class="c1"></span>    <span class="nx">NewDecoder</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">NewDecoder</span>
    <span class="c1">// NewEncoder is exported by gin/json package.
</span><span class="c1"></span>    <span class="nx">NewEncoder</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">NewEncoder</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>然后，在使用的地方import内部封装的包：<code>github.com/gin-gonic/gin/internal/json</code></p>
<p>最后，当编译时需指定tag：<code>$ go build -tags=jsoniter .</code></p>
<p><a href="https://www.flysnow.org/2017/11/05/go-auto-choice-json-libs.html">Go语言中自动选择json解析库</a></p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://juejin.im/post/5b38a6b16fb9a00e6714ab3a">拆轮子系列：gin框架</a></li>
<li><a href="http://www.itarea.cn/golang/57.html">Golang gin框架源码解析</a></li>
<li><a href="https://xguox.me/gin-source-code.html/">从 net/http 入门到 Gin 源码梳理</a></li>
<li><a href="https://github.com/hhstore/blog/issues/131">gin 源码剖析</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">linuxfish</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-10-27
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
      <a href="http://localhost:1313" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="http://localhost:1313" class="iconfont icon-twitter" title="twitter"></a>
      <a href="http://localhost:1313" class="iconfont icon-facebook" title="facebook"></a>
      <a href="http://localhost:1313" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="http://localhost:1313" class="iconfont icon-google" title="google"></a>
      <a href="http://localhost:1313" class="iconfont icon-github" title="github"></a>
      <a href="http://localhost:1313" class="iconfont icon-weibo" title="weibo"></a>
      <a href="http://localhost:1313" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="http://localhost:1313" class="iconfont icon-douban" title="douban"></a>
      <a href="http://localhost:1313" class="iconfont icon-pocket" title="pocket"></a>
      <a href="http://localhost:1313" class="iconfont icon-tumblr" title="tumblr"></a>
      <a href="http://localhost:1313" class="iconfont icon-instagram" title="instagram"></a>
      <a href="http://localhost:1313" class="iconfont icon-gitlab" title="gitlab"></a>
      <a href="http://localhost:1313" class="iconfont icon-bilibili" title="bilibili"></a>
  
  
  
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>linuxfish</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
